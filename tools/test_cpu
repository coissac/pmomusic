#!/bin/bash

echo "=== Identification CPU ==="
echo ""

# Architecture
ARCH=$(uname -m)
echo "Architecture: $ARCH"

# Mod√®le CPU
if [ -f /proc/cpuinfo ]; then
    MODEL=$(grep "model name" /proc/cpuinfo | head -1 | cut -d: -f2 | xargs)
    if [ -z "$MODEL" ]; then
        # Sur ARM, pas de "model name"
        MODEL=$(grep "Hardware" /proc/cpuinfo | head -1 | cut -d: -f2 | xargs)
    fi
    echo "Mod√®le: $MODEL"
fi

# Nombre de c≈ìurs
CORES=$(nproc)
echo "C≈ìurs: $CORES"

echo ""
echo "=== Capacit√©s SIMD ==="

if [[ "$ARCH" == "x86_64" || "$ARCH" == "i686" ]]; then
    # x86/x86_64
    echo "Type: x86/x86_64"
    
    if grep -q "avx512" /proc/cpuinfo; then
        echo "‚úÖ AVX-512 disponible"
    fi
    
    if grep -q "avx2" /proc/cpuinfo; then
        echo "‚úÖ AVX2 disponible (recommand√© pour SIMD)"
    fi
    
    if grep -q "avx" /proc/cpuinfo; then
        echo "‚úÖ AVX disponible"
    fi
    
    if grep -q "sse4_2" /proc/cpuinfo; then
        echo "‚úÖ SSE4.2 disponible"
    fi
    
    if grep -q "fma" /proc/cpuinfo; then
        echo "‚úÖ FMA (Fused Multiply-Add) disponible"
    fi
    
elif [[ "$ARCH" == "aarch64" ]]; then
    # ARM 64-bit
    echo "Type: ARM 64-bit"
    
    FEATURES=$(grep "Features" /proc/cpuinfo | head -1)
    
    if echo "$FEATURES" | grep -q "asimd"; then
        echo "‚úÖ NEON/Advanced SIMD disponible (recommand√©)"
    fi
    
    if echo "$FEATURES" | grep -q "fp"; then
        echo "‚úÖ FPU mat√©riel disponible"
    fi
    
    if echo "$FEATURES" | grep -q "sve"; then
        echo "‚úÖ SVE (Scalable Vector Extension) disponible"
    fi
    
elif [[ "$ARCH" == "armv7l" || "$ARCH" == "armv6l" ]]; then
    # ARM 32-bit
    echo "Type: ARM 32-bit"
    
    FEATURES=$(grep "Features" /proc/cpuinfo | head -1)
    
    if echo "$FEATURES" | grep -q "neon"; then
        echo "‚úÖ NEON disponible (SIMD)"
    fi
    
    if echo "$FEATURES" | grep -q "vfpv4"; then
        echo "‚úÖ VFPv4 (FPU simple pr√©cision) disponible"
    elif echo "$FEATURES" | grep -q "vfp"; then
        echo "‚úÖ VFP (FPU basique) disponible"
    else
        echo "‚ùå Pas de FPU mat√©riel (Cortex-M0/M3?)"
    fi
fi

echo ""
echo "=== Recommandation pour audio DSP ==="

if [[ "$ARCH" == "x86_64" ]]; then
    if grep -q "avx2" /proc/cpuinfo; then
        echo "üöÄ Float f64 + SIMD (std::simd avec AVX2)"
        echo "   Performance optimale garantie"
    else
        echo "‚úÖ Float f64 + SIMD (std::simd avec SSE)"
        echo "   Bonne performance"
    fi
    
elif [[ "$ARCH" == "aarch64" ]]; then
    if grep -q "asimd" /proc/cpuinfo; then
        echo "üöÄ Float f64 + SIMD (std::simd avec NEON)"
        echo "   Performance optimale sur ARM64"
    else
        echo "‚ö†Ô∏è  ARM64 sans NEON (rare)"
    fi
    
elif [[ "$ARCH" == "armv7l" ]]; then
    if grep -q "neon" /proc/cpuinfo; then
        echo "‚úÖ Float f32 + NEON SIMD"
        echo "   Bonne performance sur ARM32"
    elif grep -q "vfp" /proc/cpuinfo; then
        echo "‚öñÔ∏è  Float f32 scalaire (avec FPU)"
        echo "   Performance correcte, √©quivalent √† integer"
    else
        echo "üí° Integer fixed-point Q23"
        echo "   Pas de FPU, integer sera plus rapide"
    fi
    
elif [[ "$ARCH" == "armv6l" ]]; then
    echo "üí° Integer fixed-point Q23"
    echo "   CPU ancien, pas de FPU performant"
fi
